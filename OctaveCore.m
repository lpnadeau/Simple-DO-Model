% ------------------------------% ---> Time Stepping % ------------------------------b_D=NaN*t;b_S=b_D;b_0=b_D;b_abyss=b_D;H=b_D;psi=b_D;red=0*t;for i=1:(length(t)-1)if mod(t(i) /(365*86400),50) == 0  disp(['t =' ,num2str(t(i) /(365*86400))])endif i>1red(i) =    (1-dt/NoiseLag)*red(i-1) + sqrt(dt/NoiseLag)*randn(1);endb_S(i) = -10*(densjmd95(y(2,i),y(1,i), P_0)-rho_0)/rho_0 ;b_D(i) = -10*(densjmd95(y(4,i),y(3,i), P_0)-rho_0)/rho_0 ; b_0(i) = -10*(densjmd95(y(7,i),y(6,i), P_0)-rho_0)/rho_0 ;alpha=1-exp(-1); beta=exp(-1)-exp(-H_max/h);Db=(b_0(i)-b_D(i))/(alpha-h/(H_max-h)*beta);b_abyss(i)= b_0(i)-alpha*Db  ;tmp_bS = b_S(i) + NoiseAmp*red(i);H(i)     =   min(max(real(-h*log((tmp_bS-b_abyss(i))/Db)),delta),H_max) ;%H(i)     =  min(max(real(-h*log((b_S(i)-b_abyss(i))/Db)),delta),H_max) ;psi(i) = (psiconst/f0)*max(b_0(i)-tmp_bS,0)/(H(i)^(-2)+0.073*h^(-2))+psibg ;kappa1= kappa+0.5*kappaconv*(1+tanh(Wtanh*(b_D(i)- tmp_bS )));iceVol = @(y1) mu_ice*(min(y1-freezPoint,0))^4 ;% note: freezerate =d/dt (icevol) = -1E12* dT/dt /0.5 *exp(-T/0.5)% the following is freezrate / dT/dt%freezerate_o_dTdt = @(y1) 5e11*2*min(y1-2,0);freezerate_o_dTdt = @(y1) .3e11*4*min(y1-freezPoint,0)^3;%(iceVol - y(5,i))/dt ;% convective adjustment represented by large kappa when strat ustable% Theta_s = y(1)% notice that I am effectively re-qriting% dT/dt = latent heating / dT/dt  + other stufff% and thus% dT/dt =  other stufff /(1 - latent heating / dT/dt)  rhs1= @(tt,y1,y2,y3,y4,y5,y6,y7)  ...          ( psi(i)/(A_S*delta)*(y6-y1)      ...      +  (1/tauT)*(Tsurf-y1)* exp(-iceVol(y1)/Vo)   ...      +    kappa1/delta^2    *(y3-y1)    ...      )/(1 - 0.*(L/rho_0/A_S/delta)*freezerate_o_dTdt(y1)) ;%      +  (1/tauT)*(Tsurf-y1)* exp(-iceVol(Tmin)/Vo)   ...    % S_s     = y(2)rhs2= @(tt,y1,y2,y3,y4,y5,y6,y7)  ...        +   psi(i)/(A_S*delta)*(y7-y2)     ...       +   kappa1/delta^2    *(y4-y2)     ...       +   0.*(y2/A_S/delta)*freezerate_o_dTdt(y1)*rhs1(tt,y1,y2,y3,y4,y5,y6,y7)...       +       Fs    ;   % Theta_D = y(3)rhs3= @(tt,y1,y2,y3,y4,y5,y6,y7)  ...       + ( psi(i) + A_S*kappa1/delta )/(A_D*(H_max-h))*(y1-y3) ...       +           (A_0/A_D)*kappa_LL /(h*(H_max-h))  *(y6-y3) ...       +       FT   ;      % S_D     = y(4)rhs4= @(tt,y1,y2,y3,y4,y5,y6,y7)  ...       + ( psi(i) + A_S*kappa1/delta )/(A_D*(H_max-h))*(y2-y4) ...       +           (A_0/A_D)*kappa_LL /(h*(H_max-h))  *(y7-y4) ;% Vice    = y(5)rhs5= @(tt,y1,y2,y3,y4,y5,y6,y7)  ...                        0. ;%(freezerate(i) - linloss*y5) ; % T_0     = y(6)rhs6= @(tt,y1,y2,y3,y4,y5,y6,y7)  ...        +  psi(i)/(A_0*h)    *(y3-y6)  ...       +  1/tauT_LL*(T_0-y6)      ...       + (A_0/A_D)*(kappa_LL/h^2)*(y3-y6) ;                 % S_0     = y(7)rhs7= @(tt,y1,y2,y3,y4,y5,y6,y7)  ...        +  psi(i)/(A_0*h)    *(y4-y7)   ...       -  Fs*(A_S*delta)/(A_0*h)       ...       + (A_0/A_D)*(kappa_LL/h^2)*(y4-y7) ;                 % RK4 timestep                  y(:,i+1) = rk4(i,dt,t(i),y(:,i),rhs1,rhs2,rhs3,rhs4,rhs5,rhs6,rhs7) ;%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%y(4,i+1) =  35.18 ;           % <-- S_D fixedy(5,i+1) = iceVol(y(1,i+1));  % <-- V_ice diagnosedy(6,i+1) = T_00  -Tcool ;      % <-- T_0 fixedy(7,i+1) = 35.55       ;      % <-- S_0 fixed %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Notice that the following is only for diagnostic purposes:freezerate(i)=(y(5,i+1)-y(5,i))/dt;end % <--- End timestepping